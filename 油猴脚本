// ==UserScript==
// @name         Nexus è‡ªåŠ¨æ£€æµ‹å¹¶å¯åŠ¨èŠ‚ç‚¹ï¼ˆå¸¦è°ƒè¯•è¾“å‡ºï¼‰
// @namespace    http://tampermonkey.net
// @version      1.0
// @description  å›¾æ ‡ä¸ºç°è‰² + Cycles/s = 0 æ—¶è‡ªåŠ¨ç‚¹å‡»å¯åŠ¨æŒ‰é’®ï¼Œå¹¶åœ¨é¡µé¢æ˜¾ç¤ºè°ƒè¯•çŠ¶æ€ä¿¡æ¯
// @match        https://app.nexus.xyz/*
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    // åˆ›å»ºè°ƒè¯•æ¡†
    const debugBox = document.createElement('div');
    Object.assign(debugBox.style, {
        position: 'fixed',
        bottom: '10px',
        right: '10px',
        backgroundColor: 'rgba(0,0,0,0.85)',
        color: '#00FF00',
        fontSize: '12px',
        fontFamily: 'monospace',
        padding: '10px',
        maxHeight: '40%',
        maxWidth: '35%',
        overflow: 'auto',
        whiteSpace: 'pre-wrap',
        zIndex: 9999,
        border: '1px solid lime',
    });
    document.body.appendChild(debugBox);

    function log(msg) {
        const now = new Date().toLocaleTimeString();
        const line = `[${now}] ${msg}`;
        debugBox.innerText = line + '\n' + debugBox.innerText;
        console.log(line);
    }

    function isGrayIcon(img) {
        if (!img) return false;
        const filter = getComputedStyle(img).filter;
        return filter.includes("brightness(0)") && filter.includes("invert(1)");
    }

    function getCyclesFromBottom() {
        const containers = Array.from(document.querySelectorAll("div"))
            .filter(div => div.innerText.trim() === "Cycles/s");
        for (const label of containers) {
            const parent = label.parentElement;
            if (parent) {
                const valueDiv = parent.querySelector("div");
                if (valueDiv) {
                    const val = valueDiv.innerText.trim();
                    return /^\d+$/.test(val) ? parseInt(val) : null;
                }
            }
        }
        return null;
    }

    function simulateClick(elem) {
        const rect = elem.getBoundingClientRect();
        const x = rect.left + rect.width / 2;
        const y = rect.top + rect.height / 2;
        ['mouseover', 'mousedown', 'mouseup', 'click'].forEach(type => {
            elem.dispatchEvent(new MouseEvent(type, {
                bubbles: true,
                cancelable: true,
                view: window,
                clientX: x,
                clientY: y,
                buttons: 1
            }));
        });
    }

    function checkStatus() {
        const icon = document.querySelector('img[src="/power-settings-icon.svg"]');
        const isGray = icon && isGrayIcon(icon);
        const cycles = getCyclesFromBottom();

        const iconStatus = icon ? (isGray ? 'ğŸŸ¡ ç°è‰²ï¼ˆæœªå¯åŠ¨ï¼‰' : 'ğŸ”µ è“è‰²ï¼ˆå·²å¯åŠ¨ï¼‰') : 'âŒ æœªæ‰¾åˆ°å›¾æ ‡';
        const cyclesStatus = cycles === null ? 'âŒ æœªè·å–åˆ° Cycles/s' : `âš™ï¸ Cycles/s = ${cycles}`;
        const shouldStart = isGray && cycles === 0;

        let summary = `ğŸ§ª Nexus çŠ¶æ€è°ƒè¯•ï¼š
${iconStatus}
${cyclesStatus}
çŠ¶æ€åˆ¤å®šï¼š${shouldStart ? 'ğŸŸ¥ æœªå¯åŠ¨ â†’ å‡†å¤‡ç‚¹å‡»' : 'âœ… å·²å¯åŠ¨æˆ–æœªçŸ¥'}
        `;

        log(summary.trim());

        // å¦‚æœæ»¡è¶³å¯åŠ¨æ¡ä»¶ï¼Œåˆ™ç‚¹å‡»æŒ‰é’®
        if (shouldStart) {
            const clickable = icon.closest('div, span') || icon;
            simulateClick(clickable);
            log('âœ… å·²ç‚¹å‡»å¯åŠ¨æŒ‰é’®');
        }
    }

    // æ¯ 5 ç§’æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
    setInterval(checkStatus, 5000);
})();
